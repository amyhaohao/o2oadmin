"use strict";function chartRand(t){for(var e=[],r=0;r<t;r++)e.push(parseInt(100*Math.random()));return e}function chartDate(t,e){var r=new Date,a=r.getTime()-e*t,o=[];if(12==t){for(var n=0;n<12;n++)o.unshift(r.getFullYear()+"."+(r.getMonth()+1)),r.setDate(-1);return o}for(var n=0;n<t;n++)r.setTime(a+=e),o.push(r.getMonth()+1+"."+r.getDate());return o}function showChart(t,e){$("#chartContainer").highcharts({title:{text:"",x:-20},xAxis:{categories:t,minTickInterval:Math.ceil(t.length/20)},yAxis:{title:{text:""},plotLines:[]},series:e}),$("#chartContainer text").last().hide()}function showChart2(t,e){$("#chartContainer").highcharts({chart:{type:"column"},title:{text:""},xAxis:{categories:t,minTickInterval:Math.ceil(t.length/20)},yAxis:{min:0,title:{text:""},stackLabels:{enabled:!0,style:{fontWeight:"bold",color:Highcharts.theme&&Highcharts.theme.textColor||"gray"}}},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!0,color:Highcharts.theme&&Highcharts.theme.dataLabelsColor||"white"}}},series:e}),$("#chartContainer text").last().hide()}function isEmpty(t){return null==t||void 0==t||""===t}var o2oApp=angular.module("o2oApp",["ngRoute","o2oServices","controllers","directives"]);o2oApp.config(["$routeProvider","$locationProvider","$httpProvider",function(t,e,r){t.when("/",{templateUrl:"partials/loginForm.html",controller:"LoginFormCtrl"}).when("/shop/list/:pageSize/:page",{templateUrl:"partials/shops.html",controller:"QueryCtrl"}).when("/shop/:id",{templateUrl:"partials/shop.html",controller:"ShopCtrl"}).when("/order/list/:pageSize/:page",{templateUrl:"partials/orders.html",controller:"QueryCtrl"}).when("/order/statistic",{templateUrl:"partials/orderStatistic.html",controller:"OrderStatisticCtrl"}).when("/order/:id",{templateUrl:"partials/order.html",controller:"OrderCtrl"}).when("/promotion/list/:pageSize/:page",{templateUrl:"partials/promotions.html",controller:"QueryCtrl"}).when("/promotion/:id",{templateUrl:"partials/promotion.html",controller:"PromotionCtrl"}).when("/user/list/:pageSize/:page",{templateUrl:"partials/users.html",controller:"QueryCtrl"}).when("/user/statistic",{templateUrl:"partials/userStatistic.html",controller:"UserStatisticCtrl"}).when("/template/banner/list",{templateUrl:"partials/banners.html",controller:"QueryCtrl"}).when("/template/banner/:id",{templateUrl:"partials/banner.html",controller:"BannerCtrl"}).when("/other/sysconfig",{templateUrl:"partials/sysConfigs.html",controller:"SysconfigsCtrl"}).when("/other/sysuser/list/:pageSize/:page",{templateUrl:"partials/sysusers.html",controller:"QueryCtrl"}).when("/other/sysuser/:id",{templateUrl:"partials/sysuser.html",controller:"SysuserCtrl"}).when("/other/changePass",{templateUrl:"partials/changePass.html",controller:"ChangePassCtrl"}).when("/product/list/:pageSize/:page",{templateUrl:"partials/products.html",controller:"QueryCtrl"}).when("/product/:id",{templateUrl:"partials/product.html",controller:"ProductCtrl"}).when("/template/list",{templateUrl:"partials/templates.html",controller:"QueryCtrl"}).when("/template/config/:type/:name",{templateUrl:"partials/homeConfig.html",controller:"TemplateConfigCtrl"}).otherwise({redirectTo:"/"}),e.html5Mode(!1).hashPrefix("!"),r.interceptors.push("ErrorInterceptors")}]).run(["$rootScope","$location",function(t,e){t.selectCats=[{id:1,name:"蔬菜"},{id:2,name:"水果"},{id:3,name:"肉类"},{id:4,name:"水产"}],t.username=utils.un()}]);var controllers=angular.module("controllers",[]);controllers.controller("QueryCtrl",["$scope","CommonQueryCtrl",function(t,e){e(t)}]),controllers.controller("EditCtrl",["$scope","CommonEditCtrl",function(t,e){e(t)}]),controllers.controller("ShopCtrl",["$scope","CommonEditCtrl",function(t,e){e(t,{},{status:"AWAITAUDIT",logo:"images/6.png",deliveryLimitFee:0,deliveryFee:0}),t.preSave=function(){return isEmpty(t.data.name)?(alert("请填写名称！"),!1):isEmpty(t.data.contactPhone)?(alert("请填写联系电话！"),!1):isEmpty(t.data.address)?(alert("请填写地址！"),!1):isEmpty(t.data.deliveryLimitFee)?(alert("请填写起送金额！"),!1):isEmpty(t.data.deliveryFee)?(alert("请填写配送费！"),!1):intPattern.test(t.data.deliveryLimitFee)?!!intPattern.test(t.data.deliveryFee)||(alert("配送费为整数！"),!1):(alert("起送金额为整数！"),!1)}}]),controllers.controller("ProductCtrl",["$scope","CommonEditCtrl",function(t,e){t.postGet=function(){t.data.shop+=t.data.shopId,t.data.stock=9999},e(t,{},{logo:"images/6.png",categoryName:"蔬菜",onSale:1,stock:9999}),t.prodParams=[{}],t.pics=[{type:0,value:"images/6.png"},{type:1}],t.preSave=function(){return isEmpty(t.data.name)?(alert("请填写名称！"),!1):isEmpty(t.data.unitPrice)?(alert("请填写价格！"),!1):isEmpty(t.data.stock)?(alert("请填写库存！"),!1):isEmpty(t.data.shop)?(alert("请填写店铺！"),!1):f1Pattern.test(t.data.unitPrice)?!!intPattern.test(t.data.stock)||(alert("库存为整数！"),!1):(alert("价格为1位小数！"),!1)},t.save2=function(){for(var e=0;e<t.prodParams.length;e++)if(!t.prodParams[e].name||!t.prodParams[e].value)return void alert("请填写名称和内容！");alert("保存成功！")},t.save3=function(){}}]),controllers.controller("OrderCtrl",["$scope","CommonEditCtrl","svc",function(t,e,r){e(t),r.products({},function(e){t.products=e.slice(0,5)})}]),controllers.controller("OrderStatisticCtrl",["$scope","$location",function(t,e){function r(){"line"==t.mode?showChart(a,o):1==o.length?showChart2(a,o):showChart2(a,[{name:o[0].name,data:o[0].data},{name:o[1].name,data:o[1].data}])}if(!t.username)return void e.url("/");t.period=0,t.shop=t.username="",t.mode="line",t.status="";var a,o,n=[30,30,30,12],i=[864e5,2592e5,5184e5,0];t.confirm=function(){var e=n[t.period];a=chartDate(e,i[t.period]);var s=chartRand(e);o=[{name:t.status+"订单总数",data:s}],t.showSearch=!1,r()},t.changeMode=function(e){e!=t.mode&&(t.mode=e,r())},t.confirm()}]),controllers.controller("PromotionCtrl",["$scope","CommonEditCtrl","svc",function(t,e,r){e(t),t.preSave=function(){return t.data.name?t.data.startDate?t.data.endDate?t.data.subTotal||t.data.new?t.data.amount||t.data.ship?t.data.startDate.toTime()>t.data.endDate.toTime(!0)?(alert("开始日期必须小于结束日期！"),!1):t.data.subTotal&&!f2Pattern.test(t.data.subTotal)?(alert("商品金额为2位小数！"),!1):!(t.data.amount&&!f2Pattern.test(t.data.amount))||(alert("优惠金额为2位小数！"),!1):(alert("请填写优惠内容！"),!1):(alert("请填写优惠条件！"),!1):(alert("请填写结束日期！"),!1):(alert("请填写开始日期！"),!1):(alert("请填写优惠名称！"),!1)}}]),controllers.controller("UsersCtrl",["$scope","CommonQueryCtrl","UserSvc",function(t,e,r){t.preSearch=function(){void 0==t.search.hasOrder&&(t.search.hasOrder="false")},e(t,r),t.resetPass=function(t){confirm("确定要重置用户‘"+t.userName+"’的密码吗？")&&r.reset({id:t.id},function(t){alert("重置密码"+(t.success?"成功":"失败")+"！")})}}]),controllers.controller("UserStatisticCtrl",["$scope","$location",function(t,e){function r(){"line"==t.mode?showChart(a,o):1==o.length?showChart2(a,o):showChart2(a,[{name:o[0].name,data:o[0].data},{name:o[1].name,data:o[1].data}])}if(!t.username)return void e.url("/");t.period=0,t.mode="line";var a,o,n=[30,12],i=[5184e5,0];t.confirm=function(){var e=n[t.period];a=chartDate(e,i[t.period]);for(var s=chartRand(e),l=chartRand(e),c=[s[0]+l[0]],d=1;d<s.length;d++)s[d]+=s[d-1],l[d]+=l[d-1],c.push(s[d]+l[d]);o=[{name:"Android用户数",data:s},{name:"IOS用户数",data:l},{name:"总用户数",data:c}],r()},t.confirm()}]),controllers.controller("BannerCtrl",["$scope","CommonEditCtrl","svc",function(t,e,r){e(t,{},{img:"images/6.png"}),t.preSave=function(){return"images/6.png"==t.data.img?(alert("请上传图片！"),!1):!(t.data.sort&&!intPattern.test(t.data.sort))||(alert("排序为整数！"),!1)}}]),controllers.controller("SysconfigsCtrl",["$scope","CommonQueryCtrl",function(t,e){e(t),t.edit=function(e){t.currentData=$.extend({},t.data[e]),t.showEdit=!0,t.currentIndex=e},t.save=function(){return t.currentData.name?t.currentData.value?(t.currentIndex==-1?t.data.push(t.currentData):t.data[t.currentIndex]=t.currentData,void(t.showEdit=!1)):void alert("请填写参数值！"):void alert("请填写参数名！")}}]),controllers.controller("SysuserCtrl",["$scope","CommonEditCtrl",function(t,e){t.postGet=function(){t.data.disable=0!=t.data.status},t.preSave=function(){return!!t.data.name||(alert("请填写用户名！"),!1)},e(t,{},{role:1})}]),controllers.controller("ChangePassCtrl",["$scope","$location",function(t,e){return t.username?void(t.submit=function(){return isEmpty(t.oldPass)?void alert("请填写原密码！"):isEmpty(t.newPass)?void alert("请填写新密码！"):isEmpty(t.confirmPass)?void alert("请填写确认密码！"):t.confirmPass!=t.newPass?void alert("新密码不一致！"):void alert("密码修改成功！")}):void e.url("/")}]),controllers.controller("LoginFormCtrl",["$scope","$location",function(t,e){t.data={userName:"test",password:"test"},t.submit=function(){return isEmpty(t.data.userName)||isEmpty(t.data.password)?void alert("请填写用户名或密码！"):(document.cookie="un="+(t.$root.username=t.data.userName),void e.url("/shop/list/10/1"))}}]),controllers.controller("MenuCtrl",["$scope","$location",function(t,e){t.$location=e,t.logout=function(){document.cookie="un="+(t.$root.username=""),e.url("/")}}]),controllers.controller("PageCtrl",["$scope","$location",function(t,e){t.$parent.pageCtrl=this;var r=!1;this.generatePages=function(){var e=t.$parent.pageIndex-0,a=t.$parent.totalPages,o=[];e>1&&o.push({display:"prev",page:e-1});for(var n=2;n>0;n--)e-n>0&&o.push({display:e-n,page:e-n});o.push({display:e,page:0});for(var n=1;n<3;n++)e+n<=a&&o.push({display:e+n,page:e+n});e<a&&o.push({display:"next",page:e+1}),t.pages=o,r=!0},t.changePage=function(r){0!=r&&e.path(t.$parent.path+r)},t.$parent.totalPages&&t.$parent.totalPages>1&&!r&&this.generatePages()}]);var directives=angular.module("directives",[]);directives.directive("myUpload",function(){return{controller:["$scope","$attrs","$element",function(t,e,r){function a(r){if(!imgPattern.test(r.name))return void alert("请选择图片！");var a=new FileReader;a.onload=function(r){t.$apply(e.myUpload+"='"+r.target.result+"'")},a.readAsDataURL(r)}var o=r.find("input")[0],n=r.find(".drag");t.$watch(e.myUpload,function(e,r){t.uploadImg=e}),t.selectFile=function(){o.click()},o.onchange=function(){return o.files?void a(o.files[0]):void alert("不支持当前版本浏览器！")},n.on("dragenter",function(t){t.preventDefault(),t.stopPropagation()}).on("dragover",function(t){t.preventDefault(),t.stopPropagation()}).on("drop",function(t){return t.preventDefault(),t.stopPropagation(),t.originalEvent.dataTransfer.files?void a(t.originalEvent.dataTransfer.files[0]):void alert("不支持当前版本浏览器！")})}],templateUrl:"partials/upload.html"}}),directives.directive("mySrc",function(){return{controller:["$scope","$attrs","$element",function(t,e,r){r.addClass("fade"),r.on("load",function(){$(this).addClass("fadeIn")}),t.$watch(e.mySrc,function(t,e){t&&(r.removeClass("fadeIn"),e?setTimeout(function(){r.attr("src",t)},200):r.attr("src",t))})}],link:function(t){}}}),directives.directive("mySearch",function(){return{controller:["$scope","$attrs","$element",function(t,e,r){function a(t){t.target==n[0]?n.trigger("keyup"):o.hide()}r.addClass("mySearch");var o=r.find("ul").on("click",function(r){t.$eval(e.mySearch+"='"+r.target.innerHTML+"'"),t.$apply()}),n=r.find("input").on("keyup",function(){$.trim(this.value)?o.show():o.hide()});$(document).on("click",a),t.$on("$destroy",function(){$(document).off("click",a)})}],template:function(t){var e=t.attr("placeholder")||"";return t=t.attr("my-search"),'<input type="text" class="form-control" ng-model="'+t+'" placeholder="'+e+'" /><ul><li>{{'+t+"}}</li><li>{{"+t+"}}1</li><li>{{"+t+"}}2</li><li>{{"+t+"}}3</li></ul>"}}});var o2oServices=angular.module("o2oServices",["ngResource"]);o2oServices.factory("svc",["$resource",function(t){return t("",{},{shops:{url:"json/shops.json",method:"GET",cache:!1,isArray:!0},products:{url:"json/products.json",method:"GET",cache:!1,isArray:!0},orders:{url:"json/orders.json",method:"GET",cache:!1,isArray:!0},promotions:{url:"json/promotions.json",method:"GET",cache:!1,isArray:!0},users:{url:"json/users.json",method:"GET",cache:!1,isArray:!0},templates:{url:"json/templates.json",method:"GET",cache:!1,isArray:!0},sysconfigs:{url:"json/sysconfigs.json",method:"GET",cache:!1,isArray:!0},sysusers:{url:"json/sysusers.json",method:"GET",cache:!1,isArray:!0}})}]),o2oServices.factory("CommonQueryCtrl",["$location","$route","$routeParams","AllSvc","svc",function(t,e,r,a,o){return function(n,i){if(!n.username)return void t.url("/");i=i||{};var s=void 0==r.pageSize,l={};n.search=n.search||{};for(var c in r)"pageSize"!=c&&"page"!=c&&r[c]&&(n.search[c]=r[c]);n.preSearch&&n.preSearch();for(var c in n.search)if(""!=n.search[c])if(c.indexOf("Date")!=-1){var d=n.search[c],u=d.toTime(c.indexOf("endDate")!=-1||c.indexOf("EndDate")!=-1);u>0?l[c]=u:n.search[c]=""}else l[c]=n.search[c];if(setTimeout(function(){$("input[name=sstartDate],input[name=sendDate]").datepicker({format:"yyyy-mm-dd",endDate:"0d",todayHighlight:!0,autoclose:!0})},1e3),s)o[a.get()]({},i.querySuccess||function(t){n.data=t,n.postQuery&&n.postQuery()});else{var p=r.page;pagePattern.test(p)||(p=1),p-=0,p<1&&(p=1),p>10&&(p=10),n.pageIndex=p,n.totalPages=10,n.totalCount=100;var m=t.url();n.path=m.substring(0,m.lastIndexOf("/")+1),o[a.get()]({},i.querySuccess||function(t){n.data=t;for(var e=0;e<t.length;e++)n.data[e].id+=10*(n.pageIndex-1),$.extend(n.data[e],n.search);n.postQuery&&n.postQuery(),n.pageCtrl&&n.pageCtrl.generatePages()})}n.doSearch=function(){s||t.path(n.path+1),n.search.t=Date.now(),t.search(n.search)},n.del=function(t,r){confirm("确定删除 “"+r+"”吗？")&&o.del({id:t},i.delSuccess||function(t){e.reload()})}}}]),o2oServices.factory("CommonEditCtrl",["$location","$routeParams","AllSvc","svc",function(t,e,r,a){return function(o,n,i){return o.username?(o.id=e.id,pagePattern.test(o.id)||(o.id=0),o.id>100&&(o.id=0),n=n||{},o.id>0?a[r.get()]({},n.getSuccess||function(t){o.data=t[(o.id-1)%10],o.postGet&&o.postGet(),setTimeout(function(){$("input[name=startDate],input[name=endDate]").datepicker({format:"yyyy-mm-dd",endDate:"0d",todayHighlight:!0,autoclose:!0})},1e3)}):(o.data=i||{},setTimeout(function(){$("input[name=startDate],input[name=endDate]").datepicker({format:"yyyy-mm-dd",endDate:"0d",todayHighlight:!0,autoclose:!0})},1e3)),void(o.submit=function(){o.preSave&&!o.preSave()||alert("保存成功！")})):void t.url("/")}}]),o2oServices.factory("ErrorInterceptors",["$q","$location",function(t,e){var r=new Date,a=r.getTime();return{request:function(t){if(void 0==t.params&&(t.params={}),t.params.cdt=a,t.url.indexOf("json/")!=-1){var e=new Date;t.params.dt=e.getTime()}return t}}}]),o2oServices.service("AllSvc",["$injector","$location",function(t,e){this.get=function(){var t=e.path();return 0==t.indexOf("/shop/")?"shops":0==t.indexOf("/product/")?"products":0==t.indexOf("/order/")?"orders":0==t.indexOf("/promotion/")?"promotions":0==t.indexOf("/user/")?"users":0==t.indexOf("/template/")?"templates":t.indexOf("/sysconfig")!=-1?"sysconfigs":0!=t.indexOf("/sysuser/")?"sysusers":void 0}}]);var isIE="Microsoft Internet Explorer"==navigator.appName,dateTimePattern=/^\d{4}\-\d{1,2}\-\d{1,2}(\s\d{1,2}:[0-5]{0,1}\d{1}:[0-5]{0,1}\d{1}){0,1}$/,timePattern=/^\d{1,2}:[0-5]{0,1}\d{1}$/,pagePattern=/^\d+$/,intPattern=/^\d+$/,f1Pattern=/^\d+(\.\d0*)?$/,f2Pattern=/^\d+(\.\d{1,2}0*)?$/,imgPattern=/\.(png|jpeg|jpg|gif|bmp)$/i;String.prototype.toTime=function(t){if(!dateTimePattern.test(this.toString()))return 0;try{var e=new Date;e.setHours(0,0,0,0);var r=this.split(" ");if(void 0!=t&&t&&1==r.length&&(r[1]="23:59:59"),2==r.length){var a=r[1].split(":");if(a[0]-0>23)throw new Exception;e.setHours(a[0],a[1],a[2],0)}return r=r[0].split("-"),e.setFullYear(r[0],r[1]-1,r[2]),e.getTime()}catch(t){}return 0},String.prototype.toTime2=function(){if(!timePattern.test(this.toString()))return-1;try{var t=new Date;t.setTime(0);var e=this.split(":");return e[0]-0>23?-1:(t.setHours(e[0],e[1],0,0),t.getTime())}catch(t){}return-1},String.prototype.encode=function(){return encodeURIComponent(this)},String.prototype.getShopStatus=function(){var t=this.toString();return"AWAITAUDIT"==t?"待审核":"OPENING"==t?"营业中":"HALFTIME"==t?"休息中":"CLOSED"==t?"关闭":"AUDITFAILED"==t?"审核失败":t},String.prototype.getOrderStatus=function(){var t=this.toString();return"AWAIT_PAY"==t?"等待付款":"AWAIT_SHIPPED"==t?"等待发货":"CANCELLED"==t?"已取消":"SHIPPED"==t?"已发货":"COMMENTED"==t?"交易完成":t};var utils={un:function(){var t=document.cookie;if(!t)return null;var e=t.match(new RegExp("(^|;\\s?)un=(\\w*)"));return e?e[2]:null}};